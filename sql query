--Отримаємо потрібну інформацію за аккаунтами
with account_metrics as (
select
  s.date,
  sp.country,
  a.send_interval,
  a.is_verified,
  a.is_unsubscribed,
  count(a.id) as account_cnt
from `DA.account` a
join `DA.account_session` acs
on a.id = acs.account_id
join `DA.session_params` sp
on acs.ga_session_id = sp.ga_session_id
join `DA.session` s
on acs.ga_session_id = s.ga_session_id
group by
    s.date,
  sp.country,
  a.send_interval,
  a.is_verified,
  a.is_unsubscribed
)
,
--Отримаємо потрібну інформацію для листів
email_metrics as (
select
  date_add(s.date, interval es.sent_date day) as date,
    sp.country,
    a.send_interval,
    a.is_verified,
    a.is_unsubscribed,
  count(distinct es.id_message) as sent_msg,
  count(distinct ev.id_message) as visit_msg,
  count(distinct eo.id_message) as open_msg,
from `DA.email_sent` es
left join `DA.email_open` eo
on es.id_message = eo.id_message
left join `DA.email_visit` ev
on es.id_message = ev.id_message
join `DA.account` a
on es.id_account = a.id
join `DA.account_session` acs
on es.id_account = acs.account_id
join `DA.session` s
on acs.ga_session_id = s.ga_session_id
join `DA.session_params` sp
on acs.ga_session_id = sp.ga_session_id
group by
  date_add(s.date, interval es.sent_date day),
    sp.country,
    a.send_interval,
    a.is_verified,
    a.is_unsubscribed
),
--Об'єднуємо інформацію про аккаунти та листи в один датасет
union_info as (
  select
    date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed,
    sum(account_cnt) as account_cnt,
    sum(sent_msg) as sent_msg,
    sum(open_msg) as open_msg,
    sum(visit_msg) as visit_msg
  from (
    select
      acm.date,
      acm.country,
      acm.send_interval,
      acm.is_verified,
      acm.is_unsubscribed,
      acm.account_cnt,
      0 as sent_msg,
      0 as open_msg,
      0 as visit_msg
    from account_metrics acm
    union all
    select
      emm.date,
      emm.country,
      emm.send_interval,
      emm.is_verified,
      emm.is_unsubscribed,
      0 as account_cnt,
      emm.sent_msg,
      emm.open_msg,
      emm.visit_msg
    from email_metrics emm
  )
  group by date, country, send_interval, is_verified, is_unsubscribed
),
--Додаємо загальні кількості як віконні функції
total_without_2_last as (
select
  *,
  sum(account_cnt) over(partition by country) as total_country_account_cnt,
  sum(sent_msg) over(partition by country) as total_country_sent_cnt
from union_info
),
--Додаємо рейтинги, як віконні функції
result as (
select
  *,
  dense_rank() over(order by total_country_account_cnt desc) as rank_total_country_account_cnt ,
  dense_rank() over(order by total_country_sent_cnt desc) as rank_total_country_sent_cnt
from total_without_2_last
)
--Організуєм та виводимо всю отриману інформацію, робимо фільтр за записамо та виводимо інформацію за рейтингом від першого
select *
from result
where rank_total_country_account_cnt <= 10
   or rank_total_country_sent_cnt <= 10
order by total_country_account_cnt desc, total_country_sent_cnt desc
